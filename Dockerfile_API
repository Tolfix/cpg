# Installer
FROM node:16-alpine as base

# Caching
RUN apk add --no-cache libc6-compat

WORKDIR /app

RUN apk update && \
    apk upgrade && \
    apk add git

RUN npm install -g @types/node \
    && npm install -g typescript@4.3.5 

ENV YARN_CACHE_FOLDER=.yarn-cache

##########################



# deps
FROM base AS deps

COPY yarn.lock .

RUN yarn install

# prod deps
FROM base AS prod-deps

COPY --from=deps /app/ .

RUN yarn install --production --ignore-scripts --prefer-offline

RUN yarn cache clean

# builder
FROM base AS builder

COPY --from=deps /app/ .

RUN yarn turbo run build --scope=api --include-dependencies --no-deps

# runtime
FROM base

ENV NODE_ENV=production

COPY --from=prod-deps /app/ .

WORKDIR /app/apps/api

ENV DEBIAN_FRONTEND=noninteractive

LABEL author="Tolfix" maintainer="support@tolfix.com"

ENV PLUGINS "[]"
ENV DISABLE_JSON_ERROR "true"

EXPOSE 3001

COPY --from=builder /app/apps/api/build ./build

CMD ["yarn", "start"]
